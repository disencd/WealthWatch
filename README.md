# WealthWatch - Personal Finance Dashboard

A comprehensive personal finance dashboard built with Python (FastAPI), PostgreSQL, and a SvelteKit frontend. Track accounts, net worth, investments, budgets, recurring bills, receipts, and more — with shared access for couples.

## Features

- **Account Aggregation**: Track checking, savings, credit cards, investments, loans, mortgages, and real estate
- **Net Worth Tracking**: Automatic calculation with historical snapshots and trend charts
- **Investment Portfolio**: Holdings view with cost basis, gain/loss, and asset allocation
- **Advanced Budgeting**: Custom categories, sub-categories, and monthly budget tracking with progress bars
- **Auto-Categorization Rules**: If-then rules to categorize transactions by merchant pattern and amount range
- **Recurring Bill Tracking**: Monitor subscriptions and upcoming bills with due-date alerts
- **Receipt Management**: Upload and attach receipt images/PDFs to transactions
- **Cash Flow Visualization**: Sankey-style income-to-expense flow diagrams by month
- **Spending Reports**: Monthly trends, top merchants, and savings rate calculations
- **Expense Splitting**: Split expenses with friends/groups (equal, exact, percentage)
- **Family Collaboration**: Invite a partner with separate login but shared household view
- **"Yours, Mine, Ours"**: Label accounts by ownership to distinguish joint vs. individual finances

## Tech Stack

- **Backend**: Python 3.12 with FastAPI
- **ORM**: SQLAlchemy 2.0 (async) with Pydantic v2 schemas
- **Database**: PostgreSQL with asyncpg driver
- **Frontend**: SvelteKit 2 (Svelte 5) with TailwindCSS v4, Chart.js, Lucide icons
- **Authentication**: JWT (python-jose) with bcrypt password hashing (passlib)
- **Containerization**: Multi-stage Docker build (Node + Python)
- **Testing**: pytest

## Project Structure

```
wealthwatch/
├── app/                     # Python application package
│   ├── main.py              # FastAPI app entry point + SPA serving
│   ├── config.py            # Settings via pydantic-settings
│   ├── database.py          # SQLAlchemy async engine & session
│   ├── models.py            # All SQLAlchemy 2.0 models
│   ├── auth.py              # JWT, password hashing, auth deps
│   └── routers/             # FastAPI routers
│       ├── auth.py          # Register, login, profile
│       ├── family.py        # Family CRUD & members
│       ├── budget.py        # Categories, budgets, expenses, CSV import
│       ├── account.py       # Accounts & net worth
│       ├── investment.py    # Holdings & portfolio
│       ├── recurring.py     # Recurring transactions
│       ├── rules.py         # Auto-categorization rules
│       ├── receipts.py      # Receipt upload
│       ├── reports.py       # Spending trends, Sankey, savings rate
│       ├── expenses.py      # Shared expenses & splits
│       ├── groups.py        # Groups
│       ├── balances.py      # Balance calculations
│       └── settlements.py   # Settlements
├── frontend/                # SvelteKit SPA
│   ├── src/
│   │   ├── lib/             # Shared stores, API client, components
│   │   │   ├── api.ts       # Fetch wrapper with auth
│   │   │   ├── utils.ts     # Formatters (money, date, etc.)
│   │   │   ├── stores/      # Svelte stores (auth, categories)
│   │   │   └── components/  # Sidebar, Topbar, Modal, Notification
│   │   └── routes/
│   │       ├── login/       # Login page
│   │       ├── register/    # Register page
│   │       └── (app)/       # Auth-guarded layout
│   │           ├── dashboard/
│   │           ├── networth/
│   │           ├── accounts/
│   │           ├── investments/
│   │           ├── transactions/
│   │           ├── budgets/
│   │           ├── recurring/
│   │           ├── rules/
│   │           ├── reports/
│   │           ├── cashflow/
│   │           ├── expenses/
│   │           ├── groups/
│   │           ├── balances/
│   │           ├── receipts/
│   │           └── family/
│   ├── svelte.config.js     # Static adapter config
│   ├── vite.config.ts       # TailwindCSS v4 + API proxy
│   └── package.json
├── web/                     # Built frontend (generated by Docker)
├── requirements.txt         # Python dependencies
├── Dockerfile               # Multi-stage build (Node → Python)
├── docker-compose.yml       # Local dev stack
└── k8s/                     # Kubernetes manifests (Kustomize)
```

## Getting Started

### Quick Start (Docker Compose)

```bash
git clone <repository-url>
cd wealthwatch
docker compose up --build
```

Open `http://localhost:8080` for the UI, `http://localhost:8080/docs` for Swagger.

### Manual Setup

**Prerequisites**: Python 3.12+, Node 22+, PostgreSQL

1. **Backend**:
```bash
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8080
```

2. **Frontend** (separate terminal):
```bash
cd frontend
npm install
npm run dev
```

The Vite dev server runs on `http://localhost:5173` and proxies `/api` requests to the FastAPI backend on port 8080.

3. Create a `.env` file (or set env vars):
```env
DB_HOST=localhost
DB_PORT=5432
DB_USER=wealthwatch_user
DB_PASSWORD=your_db_password
DB_NAME=wealthwatch_db
JWT_SECRET=your_super_secret_jwt_key_here
```

## API Endpoints

All endpoints below (except Auth and Health) require a valid JWT in the `Authorization: Bearer <token>` header.

### Authentication
- `POST /api/v1/auth/register` - Register a new user (auto-creates family & default categories)
- `POST /api/v1/auth/login` - Login, returns JWT token
- `GET /api/v1/profile` - Get current user profile

### Accounts
- `GET /api/v1/accounts` - List accounts (filter: `?ownership=mine|yours|ours`)
- `POST /api/v1/accounts` - Create account
- `GET /api/v1/accounts/:id` - Get account
- `PUT /api/v1/accounts/:id` - Update account
- `DELETE /api/v1/accounts/:id` - Delete account

### Net Worth
- `GET /api/v1/networth/summary` - Current net worth with asset/liability breakdown by type
- `GET /api/v1/networth/history` - Historical net worth snapshots
- `POST /api/v1/networth/snapshot` - Take a point-in-time snapshot

### Investments
- `GET /api/v1/investments` - List holdings
- `POST /api/v1/investments` - Add holding
- `GET /api/v1/investments/:id` - Get holding
- `PUT /api/v1/investments/:id` - Update holding
- `DELETE /api/v1/investments/:id` - Delete holding
- `GET /api/v1/investments/portfolio` - Portfolio summary (total value, cost basis, gain/loss)

### Budget Categories & Expenses
- `GET /api/v1/budget/categories` - List categories
- `POST /api/v1/budget/categories` - Create category
- `GET /api/v1/budget/subcategories` - List sub-categories
- `POST /api/v1/budget/subcategories` - Create sub-category
- `GET /api/v1/budget/budgets` - List budgets (filter: `?year=&month=`)
- `POST /api/v1/budget/budgets` - Create budget
- `GET /api/v1/budget/expenses` - List transactions (filter: `?category_id=&year=&month=`)
- `POST /api/v1/budget/expenses` - Add transaction
- `GET /api/v1/budget/summary/monthly` - Monthly spending summary by category

### Recurring Bills
- `GET /api/v1/recurring` - List recurring transactions
- `POST /api/v1/recurring` - Create recurring bill
- `PUT /api/v1/recurring/:id` - Update recurring bill
- `DELETE /api/v1/recurring/:id` - Delete recurring bill
- `GET /api/v1/recurring/upcoming` - Upcoming bills (next 30 days)

### Auto-Categorization Rules
- `GET /api/v1/rules` - List rules
- `POST /api/v1/rules` - Create rule
- `PUT /api/v1/rules/:id` - Update rule
- `DELETE /api/v1/rules/:id` - Delete rule

### Receipts
- `GET /api/v1/receipts` - List receipts
- `POST /api/v1/receipts` - Upload receipt (multipart form: `file`, `merchant`, `amount`, `date`, `notes`)
- `GET /api/v1/receipts/:id` - Get receipt metadata
- `DELETE /api/v1/receipts/:id` - Delete receipt and file

### Reports
- `GET /api/v1/reports/spending-trends?months=N` - Monthly spending totals
- `GET /api/v1/reports/spending-by-merchant?limit=N` - Top merchants by spend
- `GET /api/v1/reports/cashflow-sankey?year=&month=` - Cash flow Sankey data (income → expense links)
- `GET /api/v1/reports/savings-rate?year=&month=` - Savings rate for a given month

### Split Expenses
- `POST /api/v1/expenses` - Create expense with splits
- `GET /api/v1/expenses` - List expenses

### Groups
- `POST /api/v1/groups` - Create group
- `GET /api/v1/groups` - List groups
- `GET /api/v1/groups/:id` - Get group
- `POST /api/v1/groups/:id/members` - Add member
- `DELETE /api/v1/groups/:id/members/:memberId` - Remove member

### Balances & Settlements
- `GET /api/v1/balances` - Get balances with all users
- `GET /api/v1/balances/users/:userId` - Balance with specific user
- `POST /api/v1/settlements` - Create settlement
- `GET /api/v1/settlements` - List settlements
- `PUT /api/v1/settlements/:id/status` - Update settlement status

### Family
- `POST /api/v1/families` - Create family
- `GET /api/v1/families` - List user's families
- `GET /api/v1/families/members` - List family members
- `POST /api/v1/families/members` - Invite member (by email)
- `PUT /api/v1/families/members/:id/role` - Update member role
- `DELETE /api/v1/families/members/:id` - Remove member

### Health Check
- `GET /health` - Health check endpoint

## Database Schema

The application uses the following entities (auto-migrated on startup):

- **User** - Authentication and profile
- **Family / FamilyMembership** - Household grouping with roles
- **Account** - Financial accounts (checking, savings, credit card, investment, loan, mortgage, real estate)
- **InvestmentHolding** - Individual securities/crypto holdings
- **NetWorthSnapshot** - Point-in-time net worth records
- **Category / SubCategory** - Budget categories per family
- **Budget** - Monthly/yearly spending limits per category
- **BudgetExpense** - Individual transactions linked to categories
- **RecurringTransaction** - Subscriptions and recurring bills
- **AutoCategoryRule** - Merchant-pattern-based auto-categorization
- **Receipt** - Uploaded receipt files with metadata
- **Group / GroupMember** - Groups for expense splitting
- **Expense / Split** - Shared expenses with splits
- **Settlement** - Payments between users

## Usage Examples

### Register and Login

```bash
# Register
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"first_name":"Alice","last_name":"Smith","email":"alice@example.com","password":"secret123"}'

# Login
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"alice@example.com","password":"secret123"}'
```

### Add an Account

```bash
curl -X POST http://localhost:8080/api/v1/accounts \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"institution_name":"Chase","account_name":"Checking","account_type":"checking","ownership":"ours","balance":5200.00}'
```

### Take a Net Worth Snapshot

```bash
curl -X POST http://localhost:8080/api/v1/networth/snapshot \
  -H "Authorization: Bearer <token>"
```

### Upload a Receipt

```bash
curl -X POST http://localhost:8080/api/v1/receipts \
  -H "Authorization: Bearer <token>" \
  -F "file=@receipt.jpg" \
  -F "merchant=Costco" \
  -F "amount=142.50" \
  -F "date=2025-01-15"
```

## Development

### Backend

```bash
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8080
```

### Frontend

```bash
cd frontend
npm install
npm run dev          # Dev server with HMR at :5173
npm run build        # Production build → frontend/build/
npm run preview      # Preview production build
```

### Tests

```bash
python -m pytest tests/ -v
```

### Docker Compose (full stack)

```bash
docker compose up --build
```

The multi-stage Dockerfile builds the SvelteKit frontend (Node 22), installs Python deps, and copies the static build into the final image. FastAPI serves the SPA with a catch-all fallback to `index.html`.

### Kubernetes (DigitalOcean DOKS / AWS EKS)

Kubernetes manifests are provided under `k8s/` using Kustomize.

- **Base manifests**: `k8s/base`
- **DigitalOcean overlay**: `k8s/overlays/doks`
- **AWS EKS overlay**: `k8s/overlays/eks`

1) Build and push the Docker image to a registry (DOCR for DOKS, ECR for EKS, or any OCI registry)

2) Update:

- `k8s/base/app-deployment.yaml` with your image reference
- `k8s/base/app-configmap.yaml` for DB connection values
- `k8s/base/app-secret.yaml` for `DB_PASSWORD` and `JWT_SECRET`
- `k8s/base/app-ingress.yaml` with your domain

3) Apply:

```bash
kubectl apply -k k8s/overlays/doks
# or
kubectl apply -k k8s/overlays/eks
```

### Database Migrations

All tables are auto-created on startup via SQLAlchemy `Base.metadata.create_all`.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## License

This project is licensed under the MIT License.
